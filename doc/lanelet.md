# Lanelet Facts
For more detailed description of the lanelet framework please see [paper](https://www.mrt.kit.edu/z/publ/download/2018/Poggenhans2018Lanelet2.pdf) and [Github](https://github.com/fzi-forschungszentrum-informatik/Lanelet2). You may find examples of the lanelet maps in the [INTERACTION dataset](https://interaction-dataset.com/)

![Lanelet map example](./fig/DR_CHN_Merging_ZS.png) 

1. How is the lanelet maps files (.osm) structured? 
    * Lanelet files are structured according to the layers they are defined on: nodes, ways, and relations. They are stored separately as objects in a format similar to .xml files. Nodes are key points that are connected to form roads and road objects. Ways are list of nodes - they are typically a line segment connecting multiple nodes. For categorization and visualization purposes, each way is associated with a type (e.g., line_thin) and a subtype (e.g., dashed). Relations are list of ways that are next to each other. 
2. How do the relations store information?
    * The relations store ways that are close to each other. There are typically 2 ways per relation. The 2 ways are typically parallel to each other and one is typically labeled as "left" and the other "right". However, the ways do not follow cardinality indicated by the labels; sometimes (actually very often) the ways are in a top and bottom relationship and the order is not even consistent. However, the 2 ways typically represent a lane segment. In addition, not all ways are covered by the relations; there are ways that are not associated with any relations, even though cars traverse on those ways (e.g., see DR_USA_Roundabout_EP in the INTERACTION dataset). Some ways may also appear in multiple relations as they are next to multiple other ways. 
3. What's your approach to labeling continuing lane lines from a lanelet map? 
    * We want to identify continuing lane lines from a lanelet map because we want to know which road a vehicle is on. However, each way is only a very small line segment and does not give us such global information. We tackle this with automatic lane identification and mantual labeling. 
    
        To automativally identify continuing lanes from ways, we first find all ways in the map, storing their type, subtype, and x and y coordinates. Then for each combination of type and subtype, we construct a graph (using the networkx library) of all ways in this category, where each way is a node and there is an edge between two nodes if the two ways are connected. Finally, we find all nodes reachable from the current node, store these nodes as a lane, and delete them from the current list of remaining nodes. 

        In order to assign a lane number to a vehicle, we need to label all the lane lines. We will label each lanes with an integer number and count lane numbers in the direction of the x and y axis (we are currently ignoring lanes with complex geometry, such as roundabouts). For example, in the figure above, ways 10043-10050 would be lane 1, 10044-10014 would be lane 2. However, there are complicated cases such as two lanes merging into one lane, or a rather wide region between two lanes. Our solution is for each continuing lane, i.e., lanes without intersections or roundabouts, we assign all lane dividers to the same label. For example in the figure above, 10020, 10000, 10060 will all be assigned the same label, and 10067-10069, 10062-10012 will all be assigned the same label. A merging lane will be given multiple labels, in the order of its original lane number and then the merged lane number. Guiding lanes that do not represent physical boundaries are labeled as None. 
        
        Note that for any road its outer most lane must be either guardrail or white solid lines. In the figure above, way 10023 and 10014 are dashed lines. This is in fact an error in the INTERACTION data as they should be white solid lines. One can check the INTERACTION paper (Fig. 2b) to confirm. 

4. What's your strategy for finding a vehicle's lane position?
    * Most works define a vehicle's lane position as deviation from the lane center. However, lane center is difficult to identify, especially when the lane is not straight. We define a vehicle's lane position as its distance to two adjacent lane.

    We will first identify these two adjacent lanes by following the procedure: 1) remove all lane assigned label None, e.g., guiding lanes, 2) calculate the distance between the vehicle's center of mass and all nodes in the map, 3) find the closest node to the vehicle, 4) determine the node's lane affiliation and assign this lane to the vehicle, 5) remove all ways in this lane, 5) find the closest remaining node to the vehicle, 6) determine this node's lane affiliation and assign this lane to the vehicle. The two lanes assigned should have distinct labels, and the difference between the two labels should typically be 1. If the vehicle is in a lane after it has been merged, such that the difference between the two labels is greater than 1 and in this case typically 2, we will pick the next value in a lane's list of labels, until the different between the labels become one. 

    We will then calculate the vehicle's distance to each lane identified. We will 1) use the vehicle-to-node distances calculated above to idenfity the closest node in each lane, 2) find the ways belonging to each node, and 3) calculate the relative distances using the [distance formula](https://en.wikipedia.org/wiki/Distance_from_a_point_to_a_line#Line_defined_by_two_points). 